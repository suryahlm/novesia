generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  emailVerified    DateTime?
  password         String?
  name             String?
  image            String?
  role             Role              @default(USER)
  locale           String            @default("id")
  coins            Int               @default(0)
  isVip            Boolean           @default(false)
  vipExpiresAt     DateTime?
  readingStreak    Int               @default(0)
  lastCheckIn      DateTime?
  totalReadTime    Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  accounts         Account[]
  bookmarks        Bookmark[]
  collections      Collection[]
  comments         Comment[]
  dailyTaskClaims  DailyTaskClaim[]
  notifications    Notification[]
  novelRequests    NovelRequest[]
  ratings          Rating[]
  readingHistory   ReadingHistory[]
  referredBy       Referral?         @relation("referred")
  referrals        Referral[]        @relation("referrer")
  sessions         Session[]
  transactions     Transaction[]
  unlockedChapters UnlockedChapter[]
  userBadges       UserBadge[]
  forumPosts       ForumPost[]
}

model UserBadge {
  id         String   @id @default(cuid())
  userId     String
  badgeId    String
  unlockedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Novel {
  id               String            @id @default(cuid())
  title            String
  slug             String            @unique
  synopsis         String
  cover            String?
  author           String?
  status           NovelStatus       @default(ONGOING)
  sourceUrl        String?
  isManual         Boolean           @default(false)
  totalViews       Int               @default(0)
  avgRating        Float             @default(0)
  ratingCount      Int               @default(0)
  isPremium        Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  coinCost         Int               @default(5)
  freeChapterLimit Int               @default(0)
  language         String            @default("id") // "id" = Indonesia, "en" = English
  bookmarks        Bookmark[]
  chapters         Chapter[]
  collections      CollectionNovel[]
  comments         Comment[]
  ratings          Rating[]
  genres           Genre[]           @relation("GenreToNovel")
}

model Chapter {
  id                String            @id @default(cuid())
  novelId           String
  chapterNumber     Int
  title             String
  contentOriginal   String?
  contentTranslated String
  wordCount         Int               @default(0)
  isPremium         Boolean           @default(false)
  coinCost          Int               @default(0)
  views             Int               @default(0)
  sourceUrl         String?
  isPublished       Boolean           @default(false)
  publishedAt       DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  novel             Novel             @relation(fields: [novelId], references: [id], onDelete: Cascade)
  comments          Comment[]
  readingHistory    ReadingHistory[]
  unlockedBy        UnlockedChapter[]

  @@unique([novelId, chapterNumber])
  @@index([novelId])
  @@index([isPublished])
}

model Genre {
  id     String  @id @default(cuid())
  name   String  @unique
  slug   String  @unique
  icon   String?
  novels Novel[] @relation("GenreToNovel")
}

model ReadingHistory {
  id          String    @id @default(cuid())
  userId      String
  chapterId   String
  progress    Int       @default(0)
  readAt      DateTime  @default(now())
  completedAt DateTime?
  chapter     Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chapterId])
  @@index([userId])
  @@index([completedAt])
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  novelId   String
  createdAt DateTime @default(now())
  novel     Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, novelId])
  @@index([userId])
}

model UnlockedChapter {
  id         String   @id @default(cuid())
  userId     String
  chapterId  String
  unlockedAt DateTime @default(now())
  chapter    Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chapterId])
}

model Comment {
  id        String    @id @default(cuid())
  userId    String
  novelId   String?
  chapterId String?
  content   String
  likes     Int       @default(0)
  parentId  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  chapter   Chapter?  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  novel     Novel?    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([novelId])
  @@index([chapterId])
}

model Rating {
  id        String   @id @default(cuid())
  userId    String
  novelId   String
  score     Int
  review    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  novel     Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, novelId])
}

model Collection {
  id          String            @id @default(cuid())
  userId      String
  name        String
  description String?
  isPublic    Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  novels      CollectionNovel[]

  @@index([userId])
}

model CollectionNovel {
  id           String     @id @default(cuid())
  collectionId String
  novelId      String
  addedAt      DateTime   @default(now())
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  novel        Novel      @relation(fields: [novelId], references: [id], onDelete: Cascade)

  @@unique([collectionId, novelId])
}

model Transaction {
  id          String          @id @default(cuid())
  userId      String
  type        TransactionType
  amount      Int
  paymentId   String?
  status      PaymentStatus   @default(PENDING)
  description String?
  metadata    Json?
  createdAt   DateTime        @default(now())
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CoinPackage {
  id        String   @id @default(cuid())
  name      String
  coins     Int
  priceIdr  Int
  bonus     Int      @default(0)
  isPopular Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model Referral {
  id         String   @id @default(cuid())
  referrerId String
  referredId String   @unique
  bonusGiven Boolean  @default(false)
  createdAt  DateTime @default(now())
  referred   User     @relation("referred", fields: [referredId], references: [id])
  referrer   User     @relation("referrer", fields: [referrerId], references: [id])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ScrapeJob {
  id              String       @id @default(cuid())
  novelUrl        String
  status          ScrapeStatus @default(PENDING)
  totalChapters   Int          @default(0)
  scrapedChapters Int          @default(0)
  novelId         String?
  error           String?
  logs            String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime     @default(now())
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model NovelRequest {
  id        String             @id @default(cuid())
  title     String
  author    String?
  status    NovelRequestStatus @default(PENDING)
  adminNote String?
  userId    String
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DailyTaskClaim {
  id        String   @id @default(cuid())
  userId    String
  taskId    String
  reward    Int
  claimedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([claimedAt])
}

model ForumCategory {
  id          String      @id @default(cuid())
  name        String      @unique
  slug        String      @unique
  description String?
  icon        String?
  order       Int         @default(0)
  createdAt   DateTime    @default(now())
  posts       ForumPost[]
}

model ForumPost {
  id         String        @id @default(cuid())
  title      String
  content    String
  userId     String
  categoryId String
  views      Int           @default(0)
  likes      Int           @default(0)
  isPinned   Boolean       @default(false)
  isLocked   Boolean       @default(false)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  category   ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([categoryId])
  @@index([createdAt])
}

enum Role {
  USER
  ADMIN
}

enum NovelStatus {
  ONGOING
  COMPLETED
  HIATUS
  DROPPED
}

enum TransactionType {
  COIN_PURCHASE
  COIN_EARNED
  COIN_SPENT
  VIP_SUBSCRIPTION
  REFERRAL_BONUS
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum NotificationType {
  NEW_CHAPTER
  SYSTEM
  REWARD
  COMMENT_REPLY
}

enum ScrapeStatus {
  PENDING
  SCRAPING
  TRANSLATING
  COMPLETED
  FAILED
}

enum NovelRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}
